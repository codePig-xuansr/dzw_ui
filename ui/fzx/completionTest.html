<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<style>
			#comVm{
				padding: 5px 0 0 5px;
				
			}
			.el-tabs__nav-wrap::after{
				content: none !important;
			}
			.el-tabs__header {
				margin: 0 !important;
				height: 10px !important;
			}
			.el-radio{
				margin-right: 0 !important;
			}
		</style>
	</head>
	<body>
		<div id="comVm">
			<el-card>
				<el-row>
				  <el-col :span="24">
					  <el-form :model="cominfo" inline="true">
						<el-form-item label="开单日期：">
							<template>
								<el-date-picker style="width: 170px;" :editable="false" placeholder="请选择日期" v-model="cominfo.recorddate" format="yyyy年MM月dd日" value-format="yyyy-MM-dd"></el-date-picker>
							</template>
						</el-form-item>
						<el-form-item label="竣工状态：">
							<template>
								<el-select v-model="cominfo.status" style="width: 150px;" clearable >
								  <el-option label="维修中" :value="0"></el-option>
								  <el-option label="已竣工" :value="1"></el-option>
								  <el-option label="不合格" :value="2"></el-option>
								</el-select>
							</template>
						</el-form-item>
						<el-form-item label="维修单号：">
							<el-input v-model="cominfo.recordid" placeholder="支持模糊搜索"></el-input>
						</el-form-item>
						<el-form-item>
							<el-button type="success" @click="ck">查询</el-button>
							<el-button type="primary" @click="reset">清空</el-button>
						</el-form-item>
					  </el-form>
				  </el-col>
				</el-row>
				<el-row>
				  <el-col :span="24">
					  <template>
						  <el-table :data="weixiurecord" border >
							<el-table-column v-for="(temp,index) in ms" :label="temp.name" align="center">
								<template slot-scope="scope">
									<span v-if="temp.values!='status'">{{scope.row[temp.values]}}</span>
									<span v-if="temp.values=='status'">
										<el-button v-if="scope.row.status==1" type="success" disabled>已竣工</el-button>
										<el-button v-if="scope.row.status==0" type="info" @click="jg(scope.row.recordid,scope.row.yujidate)">维修中</el-button>
										<el-button v-if="scope.row.status==2" type="danger">不合格</el-button>
									</span>
								</template>
							</el-table-column>
						  </el-table>
					  </template>
				  </el-col>
				</el-row>
				<el-row>
					<br>
				  <el-col :span="24" offset="6">
					  <template>
					 <el-pagination background prev-text="上一页" next-text="下一页" @size-change="sizec" @current-change="change" layout="total,sizes,prev, pager, next, jumper" :total="pages.total" :page-sizes="[3,6,9]" :page-size="pages.pageSize">
					  </template>
				  </el-col>
				</el-row>
			</el-card>
			
			<el-card>
				<el-row>
				  <el-col :span="24">
					 <h4 style="float: left;">竣工记录</h4>
				  </el-col>
				</el-row>
				<el-row>
				  <el-col :span="24">
					  <template>
						  <el-table :data="jgrecord" border >
							<el-table-column v-for="(temp,index) in jgr" :label="temp.name" align="center">
								<template slot-scope="scope">
									<span>{{scope.row[temp.values]}}</span>
								</template>
							</el-table-column>
						  </el-table>
					  </template>
				  </el-col>
				</el-row>
			</el-card>
			
			<el-dialog title="竣工检验" :visible.sync="cs">
				<div>
					<el-row>
					  <el-col :span="24">
						<template>
							<el-radio-group v-model="hg"  @change="tabs">
							  <el-radio label="1" border >合格</el-radio>
							  <el-radio label="2" border >不合格</el-radio>
							</el-radio-group>
							<hr>
							  <el-tabs v-model="hg">
								<el-tab-pane name="1">
									<!-- 合格 -->
									<el-form :model="completion" inline="true" :rules="ruls4" ref="completion">
									  <el-form-item label="预计完工">
										<a style="color: hotpink;font-size: 16px;">{{edate}}</a>
									  </el-form-item>
									  <el-form-item label="实际完工">
										<a style="color:chocolate;font-size: 16px;">{{today}}</a>
									</el-form-item>
									<br>
									<a v-if="wg" style="color: red;font-size: 14px;">已超过预计完工时间，请填写误工原因和处罚金额</a>
									<div style="margin-top: 15px;" v-if="wg">
										<el-form-item label="误工原因" prop="delays">
											<el-input v-model="completion.delays" style="width: 200px;" type="textarea"></el-input>
										</el-form-item>
										<br>
										<el-form-item label="处罚金额" prop="penatly">
											<el-input v-model="completion.penatly" oninput="this.value=this.value.replace(/[^\d]/g,'')" style="width: 200px;"></el-input>
										</el-form-item>
									</div>
									<el-form-item label="质检员：" prop="zjperson">
										<el-input v-model="completion.zjperson"></el-input>
									</el-form-item>
									</el-form>
								</el-tab-pane>
								<el-tab-pane name="2">
									<!-- 不合格 -->
									<el-form :model="completion" inline="true">
										<div>
									  <el-form-item label="返工原因：">
										<el-input v-model="completion.delays" style="width: 200px;" type="textarea"></el-input>
									  </el-form-item>
									  <br>
									  <el-form-item label="责任人：">
										<el-input v-model="completion.zjperson"></el-input>
									  </el-form-item>
									  <br>
									  <el-form-item label="处罚金额：">
										<el-input v-model="completion.penatly" oninput="this.value=this.value.replace(/[^\d]/g,'')" style="width: 200px;"></el-input>
									  </el-form-item>
									</div>
									</el-form>
								</el-tab-pane>
							  </el-tabs>
						</template>
						
					  </el-col>
					</el-row>
				</div>
				<span slot="footer" class="dialog-footer">
					<el-button @click="cs = false">取 消</el-button>
					<el-button type="primary" @click="comjg">确 定</el-button>
				</span>
			</el-dialog>
		</div>
	</body>
	<script>
		var comVm=new Vue({
			el:'#comVm',
			data:{
				cs:false,
				cominfo:{
					recorddate:null,
					status:null,
					recordid:null,
				},
				completion:{
					eno:'',
					//合格状态
					qualified:'',
					//误工原因
					delays:'',
					//处罚金额，
					penatly:'',
					//质检员
					zjperson:''
				},
				hg:'1',
				//显示行
				ms:[{name:'维修单号',values:'recordid'},{name:'车牌号',values:'carno'},{name:'业务类型',values:'yewutype'},{name:'单据类型',values:'danjutype'},{name:'开单时间',values:'recorddate'},{name:'预计完工',values:'yujidate'},{name:'竣工状态',values:'status'}],
				weixiurecord:[],
				jgr:[{name:'维修单号',values:'recordid'},{name:'实际完工时间',values:'shijidate'},{name:'误工原因',values:'yuanyin'},{name:'处罚金额',values:'chufa'},{name:'质检员',values:'checkperson'},{name:'负责人',values:'fuzeperson'},{name:'竣工状态',values:'jgstatus'}],
				jgrecord:[{
					recordid:'331',
					shijidate:'332',
					yuanyin:'333',
					chufa:'3334',
					checkperson:'335',
					fuzeperson:'336',
					jgstatus:'1'
				},{
					recordid:'441',
					shijidate:'442',
					yuanyin:'443',
					chufa:'444',
					checkperson:'445',
					fuzeperson:'446',
					jgstatus:'2'
				}],
				pages:{},
				edate:'',
				today:'',
				wg:true,
				ruls4:{
					delays:[{required: true, message:'请填写误工原因', trigger: 'blur'}],
					penatly:[{required: true, message:'请填写处罚金额', trigger: 'blur'}],
					zjperson:[{required: true, message:'请填写质检人员姓名', trigger: 'blur'}]
				}
			},
			methods:{
				//竣工模态框调用....
				jg(eno,edate){
					//移除校验结果
					if(this.$refs['completion']!=undefined){
						this.$refs['completion'].resetFields();
					}
					
					this.completion.eno=eno;
					this.edate=edate;
					this.today = new Date().toLocaleString('chinese',{hour12:false});
					var date1Str = new Date(Date.parse(edate));
					var date2Str = new Date(Date.parse(this.today));
					//当前时间>预计完工，true:超过
					this.wg=date2Str>date1Str;
					this.cs=true;
					
				},
				//竣工检查
				comjg(){
					let _this=this;
					this.$refs['completion'].validate((valid)=>{
						if(valid){
							this.$confirm('确认竣工？', '警告', {
								confirmButtonText: '确定',
								cancelButtonText: '取消',
								type: 'warning',
							}).then(()=>{
								if(this.hg=='1'){
									
										this.completion.qualified='0';
										jQuery.ajax({
											url: `http://localhost:8080/api/cars/comp`,
											type: 'post',
											dataType: 'json',
											contentType: 'application/json',
											data: JSON.stringify(_this.completion),
											success(data) {
												_this.$message({
													type: 'success',
													message: '竣工完成！'
												});
												_this.cs=false;
												indexVm.To('ui/fzx/completionTest.html');
											},
											error() {			
															
											}
										})
									
								}else{
									let _this=this;
									
										_this.completion.qualified='1';
											jQuery.ajax({
											url: `http://localhost:8080/api/cars/comp`,
											type: 'post',
											dataType: 'json',
											contentType: 'application/json',
											data: JSON.stringify(_this.completion),
											success(data) {
												_this.$message({
													type: 'success',
													message: '返工完成！'
												});
												_this.cs=false;
												indexVm.To('ui/fzx/completionTest.html');
											},
											error() {			
															
											}
										})
								}

							});
						}else{
							return false;
						}
					});
				},
				ck(){
					if(this.cominfo.recorddate==''){this.cominfo.recorddate=null};
					if(this.cominfo.status==''){this.cominfo.status=null};
					if(this.cominfo.recordid==''){this.cominfo.recordid=null};
					this.page(1,3,this.cominfo.recorddate,this.cominfo.status,this.cominfo.recordid);
				},
				reset(){
					this.cominfo.recorddate=null;
					this.cominfo.status='';
					this.cominfo.recordid='';
				},
				page(num,size,recorddate,status,recordid){
					let _this=this;
					jQuery.getJSON(`http://localhost:8080/api/fzx/selectFwAll/${num}/${size}/${recorddate}/${status}/${recordid}`,function(pg) {
						_this.pages = pg;
						_this.weixiurecord = pg.list;
					});
				},
				change(num){
					this.page(num,this.pages.pageSize,this.cominfo.recorddate,this.cominfo.status,this.cominfo.recordid);
				},
				sizec(size){
					this.page(1,size,this.cominfo.recorddate,this.cominfo.status,this.cominfo.recordid);
				}
			},
			mounted(){
				let _this=this;
				_this.page(1,3,_this.cominfo.recorddate,_this.cominfo.status,_this.cominfo.recordid);
			}
		});
	</script>
</html>
